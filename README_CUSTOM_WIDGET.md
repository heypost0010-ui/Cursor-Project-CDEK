# Кастомный виджет расчета доставки CDEK

## Описание

Упрощенный виджет для расчета стоимости доставки CDEK с выбором города и типа доставки.

## Особенности

1. **Константы отправления:**
   - Город отправления: Москва, ПВЗ MOS4
   - Вес: 50 кг
   - Размеры: 50×50×50 см

2. **Выбор города доставки:**
   - Поиск городов по названию
   - Автодополнение при вводе
   - Выбор из списка предложений

3. **Выбор типа доставки:**
   - До ПВЗ (самовывоз)
   - До двери (курьером)

4. **Расчет стоимости:**
   - Автоматический расчет для доступных тарифов
   - Отображение результатов с сортировкой по стоимости
   - Показ сроков доставки

## Использование

### 1. Запуск сервера

Убедитесь, что сервер запущен:

```bash
node src/server.js
```

Сервер должен работать на `http://localhost:3000`

### 2. Открытие виджета

Откройте файл `custom-delivery-widget.html` в браузере.

### 3. Использование виджета

1. **Выберите город доставки:**
   - Начните вводить название города
   - Выберите город из списка предложений

2. **Выберите тип доставки:**
   - Нажмите на "До ПВЗ" или "До двери"

3. **Рассчитайте стоимость:**
   - Нажмите кнопку "Рассчитать стоимость"
   - Дождитесь результатов

## Технические детали

### API Endpoints

Виджет использует следующие endpoints:

1. **Поиск городов:**
   ```
   GET /api/delivery/cities?q=Москва
   ```

2. **Расчет стоимости:**
   ```
   POST /api/delivery/calculate-by-tariff
   ```

### Тарифы

Виджет автоматически использует разные тарифы в зависимости от типа доставки:

- **До ПВЗ:** тарифы 136, 138, 234
- **До двери:** тарифы 137, 139, 233

### Структура данных

#### Поиск городов:
```json
{
  "success": true,
  "data": [
    {
      "code": 44,
      "city": "Москва",
      "region": "Московская область"
    }
  ]
}
```

#### Расчет стоимости:
```json
{
  "success": true,
  "tariffCode": 136,
  "deliveryCost": 350.00,
  "totalCost": 400.00,
  "periodMin": 1,
  "periodMax": 2
}
```

## Настройка

### Изменение констант

В файле `custom-delivery-widget.html` найдите секцию:

```javascript
const CONSTANTS = {
    fromCityCode: 44, // Москва
    fromAddress: 'Москва',
    weight: 50000,    // 50 кг в граммах
    length: 50,       // см
    width: 50,        // см
    height: 50        // см
};
```

Измените значения по необходимости.

### Изменение тарифов

В функции `calculateDelivery()` найдите:

```javascript
const tariffs = selectedDeliveryType === 'office' 
    ? [136, 138, 234]  // Тарифы для доставки до ПВЗ
    : [137, 139, 233]; // Тарифы для доставки до двери
```

Измените коды тарифов по необходимости.

### Изменение API URL

Если сервер работает на другом порту или адресе, измените:

```javascript
const API_BASE_URL = 'http://localhost:3000/api/delivery';
```

## Возможные проблемы

1. **Виджет не загружается:**
   - Проверьте, что сервер запущен
   - Проверьте консоль браузера на наличие ошибок
   - Убедитесь, что API доступен по адресу `http://localhost:3000`

2. **Города не находятся:**
   - Проверьте подключение к API CDEK
   - Проверьте переменные окружения в `.env`
   - Убедитесь, что endpoint `/api/delivery/cities` работает

3. **Стоимость не рассчитывается:**
   - Проверьте, что выбран город и тип доставки
   - Проверьте консоль браузера на наличие ошибок
   - Убедитесь, что endpoint `/api/delivery/calculate-by-tariff` работает

## Дальнейшее развитие

Возможные улучшения:

1. Добавить выбор ПВЗ на карте
2. Добавить ввод адреса для доставки до двери
3. Добавить кэширование результатов расчета
4. Добавить сохранение выбранных параметров в localStorage
5. Добавить поддержку нескольких посылок
6. Добавить отображение на карте

## Документация

- Документация виджета CDEK: https://github.com/cdek-it/widget/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-3.0
- Документация API CDEK: https://api-docs.cdek.ru/


