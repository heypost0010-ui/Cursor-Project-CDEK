# Описание функционала бэкенда CDEK Delivery API

## Обзор

Backend API для работы с CDEK API v2.0, предоставляющий упрощенный интерфейс для расчета стоимости доставки, поиска городов, работы с ПВЗ и создания заказов.

## Основные возможности

### 1. Авторизация и управление токенами

**Модуль:** `src/cdek/auth.js`

- ✅ Автоматическое получение OAuth токенов
- ✅ Кэширование токенов с учетом времени истечения
- ✅ Автоматическое обновление токенов при истечении
- ✅ Запас времени для обновления (60 секунд до истечения)

**Особенности:**
- Использует `client_credentials` grant type
- Токены кэшируются в памяти
- Автоматическая обработка ошибок авторизации

---

### 2. Поиск городов

**Эндпоинт:** `GET /api/delivery/cities`

**Параметры:**
- `q` (обязательный) - Название города для поиска
- `country_code` (опционально) - Код страны (по умолчанию `RU`)
- `size` (опционально) - Ограничение выборки (по умолчанию `10`)

**Пример запроса:**
```bash
GET /api/delivery/cities?q=Москва&size=20
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "code": 44,
      "city": "Москва",
      "region": "Московская область",
      "region_code": 77,
      "country": "Россия",
      "country_code": "RU"
    }
  ],
  "count": 1
}
```

**Особенности:**
- Поддержка частичного совпадения названий
- Возможность ограничения количества результатов
- Фильтрация по стране

---

### 3. Расчет стоимости доставки (все тарифы)

**Эндпоинт:** `POST /api/delivery/calculate`

**Тело запроса:**
```json
{
  "fromCityCode": 44,
  "fromAddress": "г. Москва, ул. Примерная, д. 1",
  "toCityCode": 270,
  "toAddress": "г. Новосибирск",
  "weight": 2000,
  "length": 10,
  "width": 20,
  "height": 30
}
```

**Параметры:**
- `fromCityCode` (обязательный) - Код города отправления
- `fromAddress` (обязательный) - Адрес отправления
- `toCityCode` (обязательный) - Код города доставки
- `toAddress` (обязательный) - Адрес доставки
- `weight` (обязательный) - Вес в граммах
- `length` (обязательный) - Длина в см
- `width` (обязательный) - Ширина в см
- `height` (обязательный) - Высота в см

**Ответ:**
```json
{
  "success": true,
  "tariffs": [
    {
      "code": 136,
      "name": "Посылка склад-склад",
      "description": "Доставка до склада СДЭК",
      "cost": 350.00,
      "periodMin": 1,
      "periodMax": 2,
      "calendarMin": 1,
      "calendarMax": 2,
      "deliveryDateRange": {
        "dateMin": "2025-03-25",
        "dateMax": "2025-03-26"
      }
    }
  ],
  "errors": [],
  "warnings": []
}
```

**Особенности:**
- Возвращает все доступные тарифы для маршрута
- Включает сроки доставки (рабочие дни и календарные дни)
- Поддержка диапазонов дат доставки
- Обработка ошибок и предупреждений от CDEK API

**Альтернативный эндпоинт:** `GET /api/delivery/calculate`
- Поддерживает те же параметры через query string
- Удобен для тестирования через браузер

---

### 4. Расчет стоимости по конкретному тарифу

**Эндпоинт:** `POST /api/delivery/calculate-by-tariff`

**Тело запроса:**
```json
{
  "tariffCode": 751,
  "fromCityCode": 44,
  "fromAddress": "Москва",
  "toCityCode": 270,
  "toAddress": "г. Новосибирск",
  "weight": 50000,
  "length": 50,
  "width": 50,
  "height": 50,
  "shipmentPoint": "MOS4",
  "deliveryPoint": "NSK1",
  "services": [
    {
      "code": "INSURANCE",
      "parameter": "5000"
    }
  ]
}
```

**Параметры:**
- `tariffCode` (обязательный) - Код тарифа (например, 751, 750, 136, 137)
- `fromCityCode` (обязательный) - Код города отправления
- `fromAddress` (обязательный) - Адрес отправления
- `toCityCode` (обязательный) - Код города доставки
- `toAddress` (опционально) - Адрес доставки (для доставки до двери)
- `weight` (обязательный) - Вес в граммах
- `length` (обязательный) - Длина в см
- `width` (обязательный) - Ширина в см
- `height` (обязательный) - Высота в см
- `shipmentPoint` (опционально) - Код ПВЗ отправления (для тарифа 751)
- `deliveryPoint` (опционально) - Код ПВЗ доставки (для тарифа 751)
- `services` (опционально) - Массив дополнительных услуг

**Ответ:**
```json
{
  "success": true,
  "tariffCode": 751,
  "deliveryCost": 1250.50,
  "totalCost": 1250.50,
  "periodMin": 3,
  "periodMax": 5,
  "calendarMin": 3,
  "calendarMax": 5,
  "weightCalc": 50000,
  "currency": "RUB",
  "services": [],
  "deliveryDateRange": {
    "dateMin": "2025-03-28",
    "dateMax": "2025-03-30"
  }
}
```

**Особенности:**
- Автоматический поиск ПВЗ для тарифа 751 (склад-склад)
- Приоритет поиска ПВЗ с поддержкой сборного груза (`is_ltl: true`)
- Поддержка дополнительных услуг (страхование и др.)
- Детальная информация о стоимости и сроках

**Автоматический поиск ПВЗ:**
- Если для тарифа 751 не указаны `shipmentPoint` или `deliveryPoint`, бэкенд автоматически находит подходящие ПВЗ
- Приоритет отдается ПВЗ, работающим со сборным грузом (`is_ltl: true`)

---

### 5. Получение списка офисов (ПВЗ)

**Эндпоинт:** `GET /api/delivery/offices`

**Параметры:**
- `cityCode` (обязательный) - Код города
- `type` (опционально) - Тип офиса: `PVZ`, `POSTAMAT`, `ALL` (по умолчанию `ALL`)

**Пример запроса:**
```bash
GET /api/delivery/offices?cityCode=44&type=PVZ
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "code": "MOS4",
      "name": "ПВЗ Москва 4",
      "location": {
        "address": "г. Москва, ул. Примерная, д. 1",
        "latitude": 55.7558,
        "longitude": 37.6173
      },
      "is_ltl": true,
      "work_time": "пн-пт: 10:00-20:00"
    }
  ],
  "count": 1
}
```

**Особенности:**
- Фильтрация по типу офиса (ПВЗ, постамат, все)
- Информация о поддержке сборного груза (`is_ltl`)
- Расположение и рабочие часы

---

### 6. Получение списка доступных тарифов

**Эндпоинт:** `GET /api/delivery/tariffs`

**Параметры:**
- `lang` (опционально) - Язык ответа: `rus`, `eng`, `zho` (по умолчанию `rus`)

**Пример запроса:**
```bash
GET /api/delivery/tariffs?lang=rus
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "tariff_code": 136,
      "tariff_name": "Посылка склад-склад",
      "tariff_description": "Доставка до склада СДЭК",
      "delivery_mode": 4
    },
    {
      "tariff_code": 751,
      "tariff_name": "Сборный груз склад-склад",
      "tariff_description": "Доставка сборного груза до склада",
      "delivery_mode": 4
    }
  ],
  "count": 2
}
```

**Особенности:**
- Альтернативный метод получения тарифов, если прямой эндпоинт недоступен
- Использует расчет с минимальными параметрами для получения списка тарифов
- Поддержка нескольких языков

---

### 7. Создание заказа

**Эндпоинт:** `POST /api/delivery/orders`

**Тело запроса:**
```json
{
  "type": 1,
  "number": "ORDER-12345",
  "tariffCode": 751,
  "shipmentPoint": "MOS4",
  "deliveryPoint": "NSK1",
  "toLocation": {
    "code": 270,
    "address": "г. Новосибирск, ул. Ленина, д. 1, кв. 10"
  },
  "recipient": {
    "name": "Иван Иванов",
    "phones": ["+79991234567"]
  },
  "packages": [
    {
      "number": "PACK-1",
      "weight": 50000,
      "length": 50,
      "width": 50,
      "height": 50,
      "items": [
        {
          "name": "Товар",
          "ware_key": "SKU-123",
          "cost": 10000,
          "amount": 1,
          "weight": 50000
        }
      ]
    }
  ]
}
```

**Параметры:**
- `type` (опционально) - Тип заказа: `1` - интернет-магазин, `2` - доставка (по умолчанию `1`)
- `number` (обязательный) - Номер заказа
- `tariffCode` (обязательный) - Код тарифа
- `shipmentPoint` (опционально) - Код ПВЗ отправления
- `deliveryPoint` (опционально) - Код ПВЗ доставки (альтернатива `toLocation`)
- `toLocation` (опционально) - Локация доставки `{code, address}` (альтернатива `deliveryPoint`)
- `recipient` (обязательный) - Получатель `{name, phones[]}`
- `packages` (обязательный) - Массив посылок с товарами

**Ответ:**
```json
{
  "success": true,
  "data": {
    "entity": {
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "request_uuid": "550e8400-e29b-41d4-a716-446655440001"
    }
  }
}
```

**Особенности:**
- Поддержка доставки до ПВЗ (`deliveryPoint`) и до двери (`toLocation`)
- Валидация обязательных полей
- Поддержка нескольких посылок в одном заказе
- Детализация товаров в посылках

---

## Технические особенности

### Обработка ошибок

- ✅ Валидация входных данных на всех эндпоинтах
- ✅ Детальное логирование ошибок для отладки
- ✅ Структурированные ответы об ошибках
- ✅ Обработка ошибок CDEK API с сохранением оригинальных сообщений

### Валидация данных

- ✅ Проверка обязательных параметров
- ✅ Валидация числовых значений
- ✅ Проверка форматов данных
- ✅ Автоматическое форматирование адресов

### Оптимизация

- ✅ Кэширование OAuth токенов
- ✅ Автоматический поиск ПВЗ для тарифов склад-склад
- ✅ Приоритизация ПВЗ со сборным грузом
- ✅ Минимизация запросов к CDEK API

### Безопасность

- ✅ Переменные окружения для учетных данных
- ✅ Валидация всех входных данных
- ✅ Обработка ошибок без раскрытия внутренней структуры
- ✅ CORS настройки для контроля доступа

---

## Поддерживаемые тарифы

### Сборный груз
- **751** - Сборный груз склад-склад (до ПВЗ)
- **750** - Сборный груз склад-дверь (до двери)

### Посылки
- **136** - Посылка склад-склад
- **137** - Посылка склад-дверь

### Экспресс
- **122** - Экспресс склад-дверь
- **123** - Экспресс дверь-дверь

*И другие тарифы, доступные в CDEK API*

---

## Единицы измерения

- **Вес:** граммы
- **Размеры:** сантиметры (длина, ширина, высота)
- **Стоимость:** рубли (RUB)

---

## Переменные окружения

Обязательные переменные (проверяются при запуске):
- `CDEK_API_URL` - URL API CDEK (тестовый: `https://api.edu.cdek.ru/v2`)
- `CDEK_ACCOUNT` - Account для авторизации
- `CDEK_SECURE_PASSWORD` - Secure password для авторизации

Опциональные переменные:
- `PORT` - Порт сервера (по умолчанию `3000`)
- `NODE_ENV` - Режим работы (`development` / `production`)

---

## Логирование

- Логирование всех HTTP запросов с временными метками
- Детальное логирование запросов к CDEK API (в режиме разработки)
- Логирование ошибок с полным контекстом
- Информация о получении и обновлении токенов

---

## Примеры использования

См. файл `README.md` в корне проекта для примеров запросов и ответов.

---

## Версия API

- **Версия бэкенда:** 1.0.0
- **CDEK API:** v2.0
- **Node.js:** ES Modules (ESM)

