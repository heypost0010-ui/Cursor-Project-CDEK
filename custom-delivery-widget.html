<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–∂–µ—Ç —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ CDEK</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .widget-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        .widget-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .widget-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .widget-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .delivery-type {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .delivery-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: #f9f9f9;
        }

        .delivery-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .delivery-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .delivery-option.active .icon {
            color: white;
        }

        .delivery-option .icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .delivery-option .title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .delivery-option .description {
            font-size: 12px;
            opacity: 0.8;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .calculate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            display: none;
        }

        .results.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-item .tariff-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .result-item .tariff-cost {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .result-item .tariff-period {
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 14px;
            color: #1976d2;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .city-search {
            position: relative;
        }

        .city-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .city-suggestions.show {
            display: block;
        }

        .city-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .city-suggestion:hover {
            background: #f0f0ff;
        }

        .city-suggestion.selected {
            background: #667eea;
            color: white;
        }

        .city-suggestion.exact-match {
            background: #e8f5e9;
            font-weight: 600;
        }

        .city-suggestion.exact-match:hover {
            background: #c8e6c9;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <h1>üöö –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ CDEK</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</p>
        </div>

        <div class="info-box">
            <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã):</strong>
            –û—Ç: –ú–æ—Å–∫–≤–∞, –ü–í–ó MOS4<br>
            –í–µ—Å: 50 –∫–≥ | –†–∞–∑–º–µ—Ä—ã: 50√ó50√ó50 —Å–º<br>
            <strong>–¢–∞—Ä–∏—Ñ—ã:</strong> 751 (–¥–æ –ü–í–ó) / 750 (–¥–æ –¥–≤–µ—Ä–∏) - –°–±–æ—Ä–Ω—ã–π –≥—Ä—É–∑<br>
            <small style="color: #666; margin-top: 5px; display: block;">
                üí° <strong>–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤:</strong> API CDEK –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é. 
                –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω—ã –∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º.
            </small>
        </div>

        <form id="deliveryForm">
            <div class="form-group">
                <label for="cityInput">–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                <div class="city-search">
                    <input 
                        type="text" 
                        id="cityInput" 
                        placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..."
                        autocomplete="off"
                        required
                    >
                    <div id="citySuggestions" class="city-suggestions"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px; font-size: 12px;">
                    üí° –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏ <strong>–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–∫–æ–º</strong>. –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω—ã –∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º.
                </small>
                <input type="hidden" id="cityCode" required>
            </div>

            <div class="form-group">
                <label>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                <div class="delivery-type">
                    <div class="delivery-option" data-type="office">
                        <div class="icon">üì¶</div>
                        <div class="title">–î–æ –ü–í–ó</div>
                        <div class="description">–°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</div>
                    </div>
                    <div class="delivery-option" data-type="door">
                        <div class="icon">üö™</div>
                        <div class="title">–î–æ –¥–≤–µ—Ä–∏</div>
                        <div class="description">–ö—É—Ä—å–µ—Ä–æ–º –ø–æ –∞–¥—Ä–µ—Å—É</div>
                    </div>
                </div>
                <input type="hidden" id="deliveryType" required>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn">
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
            </button>
        </form>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <h3 style="margin-bottom: 15px; color: #333;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:</h3>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)
        const CONSTANTS = {
            fromCityCode: 44, // –ú–æ—Å–∫–≤–∞
            fromAddress: '–ú–æ—Å–∫–≤–∞',
            weight: 50000,    // 50 –∫–≥ –≤ –≥—Ä–∞–º–º–∞—Ö
            length: 50,      // —Å–º
            width: 50,        // —Å–º
            height: 50        // —Å–º
        };

        // API endpoint (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à backend)
        const API_BASE_URL = 'http://localhost:3000/api/delivery';

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const cityInput = document.getElementById('cityInput');
        const cityCode = document.getElementById('cityCode');
        const citySuggestions = document.getElementById('citySuggestions');
        const deliveryOptions = document.querySelectorAll('.delivery-option');
        const deliveryType = document.getElementById('deliveryType');
        const form = document.getElementById('deliveryForm');
        const calculateBtn = document.getElementById('calculateBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');

        let selectedCity = null;
        let selectedDeliveryType = null;

        // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞
        let lastSearchResults = [];

        // –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤
        let searchTimeout;
        cityInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                citySuggestions.classList.remove('show');
                cityCode.value = '';
                selectedCity = null;
                lastSearchResults = [];
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchCities(query);
            }, 300);
        });

        async function searchCities(query) {
            try {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º size –¥–æ 100, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞–π—Ç–∏ –ú–æ—Å–∫–≤—É –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
                const response = await fetch(`${API_BASE_URL}/cities?q=${encodeURIComponent(query)}&size=100`);
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–æ–≤:', response.status);
                    citySuggestions.classList.remove('show');
                    return;
                }
                
                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤:', data);
                console.log('–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:', data.data?.length || 0);
                
                if (data.success && data.data && data.data.length > 0) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ú–æ—Å–∫–≤–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
                    const moscow = data.data.find(city => {
                        const name = (city.city || city.name || '').toLowerCase();
                        return name === '–º–æ—Å–∫–≤–∞' || city.code === 44;
                    });
                    
                    if (moscow) {
                        console.log('‚úÖ –ú–æ—Å–∫–≤–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö!', moscow);
                    } else {
                        console.log('‚ùå –ú–æ—Å–∫–≤–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö');
                        console.log('–ü–µ—Ä–≤—ã–µ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', data.data.slice(0, 10).map(c => `${c.city || c.name} (${c.code})`));
                    }
                    
                    displayCitySuggestions(data.data);
                } else {
                    citySuggestions.classList.remove('show');
                    if (query.length >= 3) {
                        showError('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
                    }
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤:', err);
                if (err.message && err.message.includes('Failed to fetch')) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3000');
                } else {
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
                citySuggestions.classList.remove('show');
            }
        }

        function displayCitySuggestions(cities) {
            citySuggestions.innerHTML = '';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞
            lastSearchResults = cities;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const query = cityInput.value.toLowerCase().trim();
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞: —Å–Ω–∞—á–∞–ª–∞ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –ø–æ—Ç–æ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ
            const sortedCities = cities.map(city => {
                const cityName = (city.city || city.name || '').toLowerCase();
                let score = 0;
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ú–æ—Å–∫–≤—ã
                if (city.code === 44 || cityName === '–º–æ—Å–∫–≤–∞') {
                    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ—Ö–æ–∂ –Ω–∞ "–º–æ—Å–∫–≤–∞" (–º—Å–∫, –º–æ—Å–∫, –º–æ—Å–∫–≤–∞ –∏ —Ç.–¥.)
                    if (query.includes('–º—Å–∫') || query.includes('–º–æ—Å–∫') || query === '–º–æ—Å–∫–≤–∞' || query === 'moscow') {
                        score = 50000; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ú–æ—Å–∫–≤—ã
                    }
                }
                
                // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                if (cityName === query) {
                    score = Math.max(score, 10000);
                }
                // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
                else if (cityName.startsWith(query)) {
                    score = Math.max(score, 5000);
                }
                // –°–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–µ —Å–ª–æ–≤–∞
                else if (cityName.includes(' ' + query) || cityName.startsWith(query + ' ')) {
                    score = Math.max(score, 2000);
                }
                // –°–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–æ—Å
                else if (cityName.includes(query)) {
                    score = Math.max(score, 1000);
                }
                // –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–ø–æ —Å–ª–æ–≤–∞–º)
                else {
                    const queryWords = query.split(/\s+/).filter(w => w.length > 0);
                    const cityWords = cityName.split(/\s+/).filter(w => w.length > 0);
                    const matchingWords = queryWords.filter(qw => 
                        cityWords.some(cw => cw.startsWith(qw) || cw.includes(qw))
                    );
                    score = Math.max(score, matchingWords.length * 100);
                }
                
                return { city, score };
            })
            .sort((a, b) => {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ score, –ø–æ—Ç–æ–º –ø–æ –¥–ª–∏–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∫–æ—Ä–æ—á–µ = –ª—É—á—à–µ)
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                const aName = (a.city.city || a.city.name || '').length;
                const bName = (b.city.city || b.city.name || '').length;
                return aName - bName;
            })
            .map(item => item.city)
            .slice(0, 15); // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 15, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ú–æ—Å–∫–≤—É
            
            sortedCities.forEach((city, index) => {
                const item = document.createElement('div');
                const cityName = city.city || city.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
                const cityNameLower = cityName.toLowerCase();
                
                // –í—ã–¥–µ–ª—è–µ–º —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                if (cityNameLower === query || cityNameLower.startsWith(query)) {
                    item.className = 'city-suggestion exact-match';
                } else {
                    item.className = 'city-suggestion';
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —É—á–µ—Ç–æ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ API
                const region = city.region || city.region_name || '';
                const text = region ? `${cityName}, ${region}` : cityName;
                item.textContent = text;
                item.addEventListener('click', () => {
                    selectCity(city);
                });
                citySuggestions.appendChild(item);
            });
            
            citySuggestions.classList.add('show');
        }

        function selectCity(city) {
            selectedCity = city;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞
            const cityName = city.city || city.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ—Ä–æ–¥';
            cityInput.value = cityName;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–¥–∞ –≥–æ—Ä–æ–¥–∞
            const code = city.code || city.city_code || city.city_code || '';
            cityCode.value = code;
            citySuggestions.classList.remove('show');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞—Å—á–µ—Ç–µ
            selectedCity.name = cityName;
            selectedCity.code = code;
            
            console.log('–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥:', selectedCity);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.city-search')) {
                citySuggestions.classList.remove('show');
            }
        });

        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        deliveryOptions.forEach(option => {
            option.addEventListener('click', function() {
                deliveryOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                selectedDeliveryType = this.dataset.type;
                deliveryType.value = selectedDeliveryType;
            });
        });

        // –£–ë–†–ê–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø—Ä–∏ blur - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–∞–º –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≥–æ—Ä–æ–¥–∞
        cityInput.addEventListener('keydown', async function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ —É–∂–µ –≤—ã–±—Ä–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á–µ—Ç
                if (selectedCity) {
                    calculateBtn.click();
                    return;
                }
                
                // –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                if (cityInput.value.trim()) {
                    const query = cityInput.value.trim().toLowerCase();
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    if (lastSearchResults && lastSearchResults.length > 0) {
                        // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
                        const exactMatch = lastSearchResults.find(city => {
                            const cityName = (city.city || city.name || '').toLowerCase();
                            return cityName === query;
                        });
                        
                        if (exactMatch) {
                            selectCity(exactMatch);
                            calculateBtn.click();
                            return;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö, –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                    try {
                        const response = await fetch(`${API_BASE_URL}/cities?q=${encodeURIComponent(cityInput.value.trim())}&size=20`);
                        const data = await response.json();
                        
                        if (data.success && data.data && data.data.length > 0) {
                            // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            const exactMatch = data.data.find(city => {
                                const cityName = (city.city || city.name || '').toLowerCase();
                                return cityName === query;
                            });
                            
                            if (exactMatch) {
                                selectCity(exactMatch);
                                calculateBtn.click();
                            } else {
                                // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                                displayCitySuggestions(data.data);
                                showError('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞. –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –Ω—É–∂–Ω–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è.');
                            }
                        } else {
                            showError('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
                        }
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–∞:', err);
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
                    }
                } else {
                    showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω
            if (!selectedCity) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –≥–æ—Ä–æ–¥ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ.');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –≥–æ—Ä–æ–¥–∞ –µ—Å—Ç—å
            const cityCodeValue = selectedCity.code || cityCode.value;
            if (!cityCodeValue) {
                console.error('–î–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞:', selectedCity);
                showError('–ö–æ–¥ –≥–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∑–∞–Ω–æ–≤–æ –∏–∑ —Å–ø–∏—Å–∫–∞');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –≥–æ—Ä–æ–¥–∞ - –≤–∞–ª–∏–¥–Ω–æ–µ —á–∏—Å–ª–æ
            const cityCodeNum = parseInt(cityCodeValue);
            if (isNaN(cityCodeNum)) {
                console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –≥–æ—Ä–æ–¥–∞:', cityCodeValue);
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –≥–æ—Ä–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∑–∞–Ω–æ–≤–æ');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏
            if (!selectedDeliveryType) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏');
                return;
            }

            console.log('–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç:', {
                city: selectedCity,
                deliveryType: selectedDeliveryType
            });

            await calculateDelivery();
        });

        async function calculateDelivery() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.classList.add('show');
            error.classList.remove('show');
            results.classList.remove('show');
            calculateBtn.disabled = true;

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–æ—Ä–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                const cityCodeValue = selectedCity.code || document.getElementById('cityCode').value;
                if (!cityCodeValue) {
                    throw new Error('–ö–æ–¥ –≥–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const toCityCode = parseInt(cityCodeValue);
                const fromCityCode = CONSTANTS.fromCityCode;

                if (toCityCode === fromCityCode) {
                    showError('–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–æ—Ä–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏.');
                    return;
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∞—Ä–∏—Ñ—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è —Å–±–æ—Ä–Ω–æ–≥–æ –≥—Ä—É–∑–∞ (50 –∫–≥)
                const tariffs = selectedDeliveryType === 'office' 
                    ? [751]  // –°–±–æ—Ä–Ω—ã–π –≥—Ä—É–∑ —Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥ (–¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ –ü–í–ó)
                    : [750]; // –°–±–æ—Ä–Ω—ã–π –≥—Ä—É–∑ —Å–∫–ª–∞–¥-–¥–≤–µ—Ä—å (–¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ –¥–≤–µ—Ä–∏)

                // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
                const tariffResults = [];
                
                for (const tariffCode of tariffs) {
                    try {
                        const result = await calculateByTariff(tariffCode);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å deliveryCost –∏–ª–∏ delivery_sum)
                        const cost = result.deliveryCost || result.delivery_sum;
                        
                        if (cost !== undefined && cost !== null) {
                            tariffResults.push({
                                code: tariffCode,
                                name: getTariffName(tariffCode),
                                cost: cost,
                                totalCost: result.totalCost || result.total_sum || cost,
                                periodMin: result.periodMin || result.period_min || 0,
                                periodMax: result.periodMax || result.period_max || 0
                            });
                        } else {
                            console.warn(`–¢–∞—Ä–∏—Ñ ${tariffCode} –≤–µ—Ä–Ω—É–ª –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:`, result);
                        }
                    } catch (err) {
                        console.warn(`–¢–∞—Ä–∏—Ñ ${tariffCode} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`, err.message);
                        console.warn('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
                        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ —Ç–∞—Ä–∏—Ñ—ã
                    }
                }

                if (tariffResults.length > 0) {
                    displayResults(tariffResults);
                } else {
                    const cityName = selectedCity.city || selectedCity.name || cityInput.value;
                    const fromCityName = '–ú–æ—Å–∫–≤–∞';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –≥–æ—Ä–æ–¥–∞
                    if (toCityCode === fromCityCode) {
                        showError(`–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ "${cityName}" —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–æ—Ä–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è "${fromCityName}". –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏.`);
                    } else {
                        showError(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ ${fromCityName} ‚Üí ${cityName}. –í–æ–∑–º–æ–∂–Ω–æ, –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥.`);
                    }
                }

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:', err);
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏';
                
                if (err.message) {
                    errorMessage += ': ' + err.message;
                } else if (err.toString) {
                    errorMessage += ': ' + err.toString();
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É
                if (err.message && err.message.includes('Failed to fetch')) {
                    errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3000';
                }
                
                showError(errorMessage);
            } finally {
                loading.classList.remove('show');
                calculateBtn.disabled = false;
            }
        }

        async function calculateByTariff(tariffCode) {
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –≥–æ—Ä–æ–¥–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π
            const cityCodeValue = selectedCity.code || document.getElementById('cityCode').value;
            if (!cityCodeValue) {
                throw new Error('–ö–æ–¥ –≥–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            const toCityCode = parseInt(cityCodeValue);
            const fromCityCode = CONSTANTS.fromCityCode;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
            if (toCityCode === fromCityCode) {
                throw new Error('–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥–æ—Ä–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥.');
            }

            const body = {
                tariffCode: tariffCode,
                fromCityCode: fromCityCode,
                fromAddress: CONSTANTS.fromAddress,
                toCityCode: toCityCode,
                weight: CONSTANTS.weight,
                length: CONSTANTS.length,
                width: CONSTANTS.width,
                height: CONSTANTS.height
            };

            // –î–ª—è —Ç–∞—Ä–∏—Ñ–∞ 750 (–¥–æ –¥–≤–µ—Ä–∏) –¥–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
            // –î–ª—è —Ç–∞—Ä–∏—Ñ–∞ 751 (–¥–æ –ü–í–ó) –∞–¥—Ä–µ—Å –Ω–µ –Ω—É–∂–µ–Ω - —ç—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞/–ü–í–ó
            if (selectedDeliveryType === 'door' && tariffCode === 750) {
                const cityName = selectedCity.city || selectedCity.name || cityInput.value;
                if (cityName) {
                    body.toAddress = cityName;
                }
            }

            console.log('–ó–∞–ø—Ä–æ—Å —Ä–∞—Å—á–µ—Ç–∞:', body);
            console.log('–ú–∞—Ä—à—Ä—É—Ç:', `${CONSTANTS.fromAddress} (${fromCityCode}) ‚Üí ${selectedCity.city || selectedCity.name} (${toCityCode})`);

            const response = await fetch(`${API_BASE_URL}/calculate-by-tariff`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON
            let data;
            try {
                data = await response.json();
            } catch (err) {
                const text = await response.text();
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', text);
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
            }
            
            console.log('–û—Ç–≤–µ—Ç API:', data);
            
            if (!response.ok) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorMsg = data.message || data.error || `HTTP ${response.status}`;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                if (data.details && Array.isArray(data.details)) {
                    errorMsg += ': ' + data.details.join(', ');
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç CDEK API
                if (data.message && data.message.includes('CDEK API Error')) {
                    try {
                        const match = data.message.match(/\{.*\}/);
                        if (match) {
                            const cdekError = JSON.parse(match[0]);
                            if (cdekError.errors && Array.isArray(cdekError.errors)) {
                                const cdekErrorMessages = cdekError.errors.map(e => e.message || e.code).join('; ');
                                if (cdekErrorMessages) {
                                    errorMsg = cdekErrorMessages;
                                }
                            }
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                    }
                }
                
                console.error('–û—à–∏–±–∫–∞ HTTP:', response.status, errorMsg, data);
                throw new Error(errorMsg);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è success (–º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
            if (data.success === false) {
                const errorMsg = data.message || data.error || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞';
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:', errorMsg, data);
                throw new Error(errorMsg);
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
            if (data.deliveryCost === undefined && data.delivery_sum === undefined) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ –æ—Ç–≤–µ—Ç–µ:', data);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏');
            }

            return data;
        }

        function getTariffName(code) {
            const names = {
                751: '–°–±–æ—Ä–Ω—ã–π –≥—Ä—É–∑ —Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥',
                750: '–°–±–æ—Ä–Ω—ã–π –≥—Ä—É–∑ —Å–∫–ª–∞–¥-–¥–≤–µ—Ä—å',
                136: '–ü–æ—Å—ã–ª–∫–∞ —Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥',
                137: '–ü–æ—Å—ã–ª–∫–∞ —Å–∫–ª–∞–¥-–¥–≤–µ—Ä—å',
                138: '–ü–æ—Å—ã–ª–∫–∞ –¥–≤–µ—Ä—å-—Å–∫–ª–∞–¥',
                139: '–ü–æ—Å—ã–ª–∫–∞ –¥–≤–µ—Ä—å-–¥–≤–µ—Ä—å',
                233: '–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π —ç–∫—Å–ø—Ä–µ—Å—Å —Å–∫–ª–∞–¥-–¥–≤–µ—Ä—å',
                234: '–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π —ç–∫—Å–ø—Ä–µ—Å—Å —Å–∫–ª–∞–¥-—Å–∫–ª–∞–¥',
            };
            return names[code] || `–¢–∞—Ä–∏—Ñ ${code}`;
        }

        function displayResults(tariffResults) {
            resultsContent.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
            tariffResults.sort((a, b) => a.cost - b.cost);

            tariffResults.forEach(tariff => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div class="tariff-name">${tariff.name}</div>
                    <div class="tariff-cost">${tariff.cost.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <div class="tariff-period">–°—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: ${tariff.periodMin}-${tariff.periodMax} –¥–Ω.</div>
                `;
                resultsContent.appendChild(item);
            });

            results.classList.add('show');
        }

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (deliveryOptions.length > 0) {
            deliveryOptions[0].click();
        }
    </script>
</body>
</html>

